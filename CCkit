#!/usr/bin/env python3
import argparse
import subprocess
import sys
import os
import json
import pathlib
import shlex
import traceback

# ====== load toos.json ======
def load_config():
    config_file = os.path.join(os.path.dirname(os.path.abspath(__file__)), "tools.json")
    if not os.path.exists(config_file):
        print("Not find tools.json !")
        sys.exit(1)
    with open(config_file, "r", encoding="utf-8") as f:
        return json.load(f)

CONFIG = load_config()

# ====== find function script ======
def find_script(script_name):
    env_paths = os.environ.get("CCkit_PATHS", "")
    if not env_paths:
        raise RuntimeError("please set CCkit_PATHS")

    search_dirs = env_paths.split(os.pathsep)

    for base_dir in search_dirs:
        base_path = pathlib.Path(base_dir)
        if not base_path.exists():
            continue
        for path in base_path.rglob(script_name):
            if path.is_file():
                return str(path.resolve())

    raise FileNotFoundError(
        f"fail to find {script_name}\n"
    )

# ====== run function script ======
def run_command(func, extra_args):
    if func not in CONFIG:
        print(f"unknown function: {func}")
        return

    info = CONFIG[func]
    if isinstance(info, dict):
        script_name = info.get("script")
    else:
        script_name = info

    try:
        script_path = find_script(script_name)
    except Exception as e:
        print(f"fail to find script: {e}")
        return

    cmd = [sys.executable, script_path] + (extra_args or [])

    print(f"\nrun command: {' '.join(shlex.quote(c) for c in cmd)}\n")

    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print(f"Execution of {func} failed, exit code: {e.returncode}")
    except KeyboardInterrupt:
        print("User Interruption: (Ctrl+C)")
    except Exception:
        print("An unexpected error occurred while running the script:")
        traceback.print_exc()

# ====== menu mode ======
def menu_mode():
    while True:
        print("\n====== Functions ======")
        for key, info in CONFIG.items():
            if isinstance(info, dict):
                script_name = info.get("script", "")
            else:
                script_name = info
            print(f"[{key}] python {script_name}")
        print("[q] Exit")

        choice = input("please choose a function(or q exit): ").strip()
        if choice.lower() == "q":
            sys.exit(0)

        if choice in CONFIG:
            arg_line = input("parameters for your function: ").strip()
            extra_args = shlex.split(arg_line) if arg_line else []
            run_command(choice, extra_args)
        else:
            print("Invalid choice")

# ====== mian() ======
def main():
    parser = argparse.ArgumentParser(description="Welcome to CCkit")

    parser.add_argument("--listall", action="store_true", help="List all available functions")
    parser.add_argument("func", nargs="?", help=f"functions (available:{', '.join(CONFIG.keys())})")
    parser.add_argument("extra", nargs=argparse.REMAINDER, help="parameters flow to function scripts")

    args = parser.parse_args()

    if args.listall:
        print("Available functions:")
        for func, info in CONFIG.items():
            if isinstance(info, dict):
                desc = info.get("desc", "")
            else:
                desc = ""
            print(f"- {func}: {desc}")
        sys.exit(0)
    if not args.func:
        menu_mode()
    else:
        run_command(args.func, args.extra)

if __name__ == "__main__":
    main()
